"use strict";function initMaps(){map=new google.maps.Map(document.getElementById("map"),{zoom:11,center:{lat:56.285399,lng:43.920782}}),districtCoords=[{lat:56.175557,lng:43.708475},{lat:56.41345,lng:43.715824},{lat:56.407577,lng:43.864439},{lat:56.340654,lng:44.081645},{lat:56.278146,lng:44.154319},{lat:56.203728,lng:43.986107}],districtArbat=new google.maps.Polygon({paths:districtCoords}),districts.push(districtArbat),map.addListener("bounds_changed",function(){console.log(),deleteMarkers(),fetch_new({south:map.getBounds().toJSON().south,east:map.getBounds().toJSON().east,west:map.getBounds().toJSON().west,north:map.getBounds().toJSON().north})}),fetch("http://gwctest.org/get_map?area=4").then(function(o){if(200!==o.status)return void console.log("Looks like there was a problem. Status Code: "+o.status);o.json().then(function(o){setMarkers(o)})}).catch(function(o){console.log("Fetch Error :-S",o)})}function setMarkers(o){o.forEach(function(o){var e=new google.maps.LatLng(parseFloat(o.lat),parseFloat(o.long)),t=new google.maps.Marker({position:e,map:map,title:o.name}),s='<div class="place"><div class="place-wrap"><div class="title">'+o.name+'</div><div class="coords">Координаты: '+o.lat+","+o.long+'</div><div class="phone">'+o.phone+'</div><div class="phone">'+o.address+'</div><div class="phone">'+o.category+'</div><div class="phone">Рейтинг: '+o.rating+'</div><div class="phone">Отзывов: '+o.reviews+'</div><div class="phone">'+o.tags+'</div><div class="website"><a href="http://'+o.website+'">'+o.website+'</a></div><div class="schedule">'+parseWeeksHTML(o.schedule)+"</div></div></div>",n=new google.maps.InfoWindow({content:s});t.addListener("click",function(){n.open(map,t)}),array.push({"Название":o.name,Lat:o.lat,Long:o.long,"Адрес":o.address,"Телефон":o.phone,"Сайт":o.website,"Расписание":parseWeeks(o.schedule),"Категории":o.category,"Тэги":o.tags,Tags:o.eng_tags}),markers.push(t)})}function setMapOnAll(o){for(var e=0;e<markers.length;e++)markers[e].setMap(o)}function clearMarkers(){setMapOnAll(null)}function deleteMarkers(){clearMarkers(),markers=[]}function parseWeeks(o){var e,t="";try{return e=JSON.parse(o),void 0!==e.Mon&&(t+="Понедельник: "+e.Mon.working_hours[0].from+"-"+e.Mon.working_hours[0].to+". "),void 0!==e.Tue&&(t+="Вторник: "+e.Tue.working_hours[0].from+"-"+e.Tue.working_hours[0].to+". "),void 0!==e.Wed&&(t+="Среда: "+e.Wed.working_hours[0].from+"-"+e.Wed.working_hours[0].to+". "),void 0!==e.Thu&&(t+="Четверг: "+e.Thu.working_hours[0].from+"-"+e.Thu.working_hours[0].to+". "),void 0!==e.Fri&&(t+="Пятница: "+e.Fri.working_hours[0].from+"-"+e.Fri.working_hours[0].to+". "),void 0!==e.Sat&&(t+="Суббота: "+e.Sat.working_hours[0].from+"-"+e.Sat.working_hours[0].to+". "),void 0!==e.Sun&&(t+="Воскресенье: "+e.Sun.working_hours[0].from+"-"+e.Sun.working_hours[0].to+". "),t}catch(e){return console.log(e),console.log(o),""}}function parseWeeksHTML(o){if(null===o)return"";var e,t="<br>";try{return e=JSON.parse(o),void 0!==e.Mon&&(t+="Понедельник: "+e.Mon.working_hours[0].from+"-"+e.Mon.working_hours[0].to+".<br>"),void 0!==e.Tue&&(t+="Вторник: "+e.Tue.working_hours[0].from+"-"+e.Tue.working_hours[0].to+".<br>"),void 0!==e.Wed&&(t+="Среда: "+e.Wed.working_hours[0].from+"-"+e.Wed.working_hours[0].to+".<br>"),void 0!==e.Thu&&(t+="Четверг: "+e.Thu.working_hours[0].from+"-"+e.Thu.working_hours[0].to+".<br>"),void 0!==e.Fri&&(t+="Пятница: "+e.Fri.working_hours[0].from+"-"+e.Fri.working_hours[0].to+".<br>"),void 0!==e.Sat&&(t+="Суббота: "+e.Sat.working_hours[0].from+"-"+e.Sat.working_hours[0].to+".<br>"),void 0!==e.Sun&&(t+="Воскресенье: "+e.Sun.working_hours[0].from+"-"+e.Sun.working_hours[0].to+".<br>"),t}catch(e){return console.log(e),console.log(o),""}}function fetch_new(o){fetch("http://gwctest.org/get_map?area=4&s="+o.south+"&e="+o.east+"&w="+o.west+"&n="+o.north).then(function(o){if(200!==o.status)return void console.log("Looks like there was a problem. Status Code: "+o.status);o.json().then(function(o){setMarkers(o)})}).catch(function(o){console.log("Fetch Error :-S",o)})}function getDocHeight(){var o=document.body,e=document.documentElement;return Math.max(o.scrollHeight,o.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight)}function needUpdate(){return window.innerHeight+window.pageYOffset>getDocHeight()-90}function fetchNewBlocks(){page++,fetch("http://gwctest.org/get_blocks?page="+page).then(function(o){if(200!==o.status)return void console.log("Looks like there was a problem. Status Code: "+o.status);o.json().then(function(o){console.log(o),limit=o.limit,document.getElementById("count").innerHTML=o.count,placeNewBlocks(o.items),loading=!1})}).catch(function(o){console.log("Fetch Error :-S",o)})}function placeNewBlocks(o){o.forEach(function(o){var e='<div class="col-md-4 place"><div class="place-wrap"><div class="title">'+o.name+'</div><div class="coords">Координаты: '+o.lat+","+o.long+'</div><div class="phone">'+o.phone+'</div><div class="phone">'+o.address+'</div><div class="phone">'+o.category+'</div><div class="phone">Рейтинг: '+o.rating+'</div><div class="phone">Отзывов: '+o.reviews+'</div><div class="phone">'+o.tags+'</div><div class="website"><a href="http://'+o.website+'">'+o.website+'</a></div><div class="schedule">'+parseWeeksHTML(o.schedule)+"</div></div></div>";document.getElementById("places").innerHTML+=e})}var map,markers=[],districtArbat,districts=[],array=[],count=0,districtCoords,page=0,loading=!1,limit=!1;window.onscroll=function(){console.log(needUpdate()),!needUpdate()||loading||limit||(loading=!0,fetchNewBlocks())},fetchNewBlocks();