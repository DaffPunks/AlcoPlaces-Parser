"use strict";

function initMaps() {
    map = new google.maps.Map(document.getElementById("map"), {zoom: 15, center: {lat: 55.752371, lng: 37.592595}});
    var o = [{lat: 55.758194, lng: 37.584223}, {lat: 55.754255, lng: 37.605706}, {
        lat: 55.756332,
        lng: 37.607122
    }, {lat: 55.754758, lng: 37.611958}, {lat: 55.749352, lng: 37.608452}, {
        lat: 55.750584,
        lng: 37.604032
    }, {lat: 55.748821, lng: 37.602573}, {lat: 55.747299, lng: 37.599011}, {
        lat: 55.746478,
        lng: 37.585621
    }, {lat: 55.744304, lng: 37.587166}, {lat: 55.743917, lng: 37.583519}, {
        lat: 55.745463,
        lng: 37.582832
    }, {lat: 55.745608, lng: 37.573906}, {lat: 55.752861, lng: 37.574065}, {
        lat: 55.755318,
        lng: 37.57648
    }, {lat: 55.755463, lng: 37.583561}];
    districtArbat = new google.maps.Polygon({paths: o}), districtArbat.setMap(map), fetch("http://gwctest.org/bars/api.php").then(function (o) {
        if (200 !== o.status) return void console.log("Looks like there was a problem. Status Code: " + o.status);
        o.json().then(function (o) {
            setMarkers(o), console.log(count), document.getElementById("count").innerHTML = count, console.log(JSON.stringify(array));
            var r = json2xls(array);
            fs.writeFileSync("data.xlsx", r, "binary")
        })
    }).catch(function (o) {
        console.log("Fetch Error :-S", o)
    })
}

function setMarkers(o) {
    o.forEach(function (o) {
        var r = new google.maps.LatLng(parseFloat(o.lat), parseFloat(o.long));
        if (google.maps.geometry.poly.containsLocation(r, districtArbat)) {
            var n = new google.maps.Marker({position: r, map: map, title: o.name});
            count++;
            var e = '<div class="col-md-4 place"><div class="place-wrap"><div class="title">' + o.name + '</div><div class="coords">Координаты: ' + o.lat + "," + o.long + '</div><div class="phone">' + o.phone + '</div><div class="phone">' + o.address + '</div><div class="website"><a href="http://' + o.website + '">' + o.website + '</a></div><div class="schedule">' + parseWeeksHTML(o.schedule) + "</div></div></div>",
                s = '<div class="place"><div class="place-wrap"><div class="title">' + o.name + '</div><div class="coords">Координаты: ' + o.lat + "," + o.long + '</div><div class="phone">' + o.phone + '</div><div class="phone">' + o.address + '</div><div class="website"><a href="http://' + o.website + '">' + o.website + '</a></div><div class="schedule">' + parseWeeksHTML(o.schedule) + "</div></div></div>",
                t = new google.maps.InfoWindow({content: s});
            n.addListener("click", function () {
                t.open(map, n)
            }), document.getElementById("places").innerHTML += e, array.push({
                "Название": o.name,
                Lat: o.lat,
                Long: o.long,
                "Адрес": o.address,
                "Телефон": o.phone,
                "Сайт": o.website,
                "Расписание": parseWeeks(o.schedule)
            })
        }
    })
}

function parseWeeks(o) {
    var r = "", n = JSON.parse(o);
    return void 0 !== n.Mon && (r += "Понедельник: " + n.Mon.working_hours[0].from + "-" + n.Mon.working_hours[0].to + ". "), void 0 !== n.Tue && (r += "Вторник: " + n.Tue.working_hours[0].from + "-" + n.Tue.working_hours[0].to + ". "), void 0 !== n.Wed && (r += "Среда: " + n.Wed.working_hours[0].from + "-" + n.Wed.working_hours[0].to + ". "), void 0 !== n.Thu && (r += "Четверг: " + n.Thu.working_hours[0].from + "-" + n.Thu.working_hours[0].to + ". "), void 0 !== n.Fri && (r += "Пятница: " + n.Fri.working_hours[0].from + "-" + n.Fri.working_hours[0].to + ". "), void 0 !== n.Sat && (r += "Суббота: " + n.Sat.working_hours[0].from + "-" + n.Sat.working_hours[0].to + ". "), void 0 !== n.Sun && (r += "Воскресенье: " + n.Sun.working_hours[0].from + "-" + n.Sun.working_hours[0].to + ". "), r
}

function parseWeeksHTML(o) {
    var r = "<br>", n = JSON.parse(o);
    return void 0 !== n.Mon && (r += "Понедельник: " + n.Mon.working_hours[0].from + "-" + n.Mon.working_hours[0].to + ".<br>"), void 0 !== n.Tue && (r += "Вторник: " + n.Tue.working_hours[0].from + "-" + n.Tue.working_hours[0].to + ".<br>"), void 0 !== n.Wed && (r += "Среда: " + n.Wed.working_hours[0].from + "-" + n.Wed.working_hours[0].to + ".<br>"), void 0 !== n.Thu && (r += "Четверг: " + n.Thu.working_hours[0].from + "-" + n.Thu.working_hours[0].to + ".<br>"), void 0 !== n.Fri && (r += "Пятница: " + n.Fri.working_hours[0].from + "-" + n.Fri.working_hours[0].to + ".<br>"), void 0 !== n.Sat && (r += "Суббота: " + n.Sat.working_hours[0].from + "-" + n.Sat.working_hours[0].to + ".<br>"), void 0 !== n.Sun && (r += "Воскресенье: " + n.Sun.working_hours[0].from + "-" + n.Sun.working_hours[0].to + ".<br>"), r
}

var map, districtArbat, array = [], count = 0;